<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>CustomeDb</title>
    <link href="/main.css" rel="stylesheet">
    <link href="/calendar.css" rel="stylesheet">


    <!-- FullCalendar v3 ìŠ¤íƒ€ì¼ì‹œíŠ¸ ì¶”ê°€ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.css" rel="stylesheet" />

    <!-- jQuery ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- moment.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (FullCalendar v3 í•„ìˆ˜) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/locale/ko.js"></script>

    <!-- FullCalendar v3 JavaScript ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.js"></script>

</head>
<body>
<div th:replace="~{ nav.html::navbar }"></div>

<!-- í˜ì´ì§€ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ -->
<div class="container">
    <!-- FullCalendarê°€ ì‚½ì…ë  ê³µê°„ -->
    <div id="calendar"></div>

    <!-- ì´ì „ ë‹¬ ë©”ëª¨ ëª©ë¡ (ì™¼ìª½) -->
    <div class="month-memos" id="monthMemosLeft">
        <h3>ì´ì „ë‹¬ ì¼ì •</h3>
        <ul id="memoListLeft"></ul>
    </div>

    <!-- ì´ë²ˆ ë‹¬ ë©”ëª¨ ëª©ë¡ (ì˜¤ë¥¸ìª½) -->
    <div class="month-memos" id="monthMemosRight">
        <h3>ì´ë²ˆë‹¬ ì¼ì •</h3>
        <ul id="memoListRight"></ul>
    </div>
     <!-- ì±„íŒ…ë°© ë²„íŠ¼ -->
    <button id="openChatModalBtn">ğŸ’¬</button>
</div>

<!-- ë©”ëª¨ ì…ë ¥ ì°½ -->
<div id="memoModal">
    <h4>ë©”ëª¨ ì‘ì„±</h4>
    <p><strong>ë‚ ì§œ: </strong><span id="selectedDateText"></span></p>
    <p><strong>ì´ë¦„: </strong><span id="displayNameText"></span></p>

    <textarea id="memoText"></textarea>
    <br>
    <button id="saveMemo">ì €ì¥</button>
    <button id="cancelMemo">ì·¨ì†Œ</button>
    <button id="deleteMemo" style="background-color: red; color: white;">ì‚­ì œ</button>
</div>
 <!--ì±„íŒ…ë°© ëª¨ë‹¬ ê´€ë ¨ HTML ë¶€ë¶„ (ìë™ìœ¼ë¡œ í‘œì‹œë˜ì§€ ì•Šë„ë¡ ë²„íŠ¼ìœ¼ë¡œë§Œ ì—´ë¦¬ê²Œ ì„¤ì •)-->
<!-- ì±„íŒ…ë°© ëª¨ë‹¬ -->
<div id="chatModalOverlay"></div>
<div id="chatModal" style="display:none;">
    <h2>ì†Œí”„íŠ¸í†¡</h2>


    <div class="input-group">
        <label for="roomId" style="align-self: center;">ë°©ì œëª©:</label>
        <input type="text" id="roomId" placeholder="Enter Room ID (e.g., room1)" value="room1">
        <button onclick="connect()">Join</button>
    </div>

    <div class="input-group">
        <input type="text" id="message" placeholder="ë©”ì„¸ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
        <button onclick="sendMessage()">Send</button>
    </div>

    <div id="chatBox"></div>

    <button onclick="closeChatModal()">ë‹«ê¸°</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="/js/chat.js"></script>
<script>
// í˜ì´ì§€ ë¡œë“œì‹œ connect()ê°€ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ìˆ˜ì •
$(document).ready(function () {
   // connect();  // ì´ ë¶€ë¶„ì„ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì‚­ì œ
    // ë‹¤ë¥¸ ìë™ ì‹¤í–‰ ì½”ë“œê°€ ìˆë‹¤ë©´ ì‚­ì œí•´ì£¼ì„¸ìš”.
});

// ì±„íŒ… ëª¨ë‹¬ì„ ì—´ê¸° ìœ„í•œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
$('#openChatModalBtn').click(function() {
    $('#chatModal').show();  // ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ì„ ë„ì›€
    $('#chatModalOverlay').show();  // ëª¨ë‹¬ ë°°ê²½ë„ ë³´ì´ê²Œ í•¨
});

// ì±„íŒ… ëª¨ë‹¬ì„ ë‹«ëŠ” í•¨ìˆ˜
function closeChatModal() {
    $('#chatModal').hide();  // ëª¨ë‹¬ì„ ìˆ¨ê¹€
    $('#chatModalOverlay').hide();  // ëª¨ë‹¬ ë°°ê²½ë„ ìˆ¨ê¹€
}

    
    
    $(document).ready(function () {
    var selectedDate = null;  // ì„ íƒëœ ë‚ ì§œë¥¼ ì €ì¥í•˜ëŠ” ë³€ìˆ˜
    var displayName = 'ì‚¬ìš©ì';  // ì‹¤ì œ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•¨
    var currentEvent = null;  // í˜„ì¬ ì„ íƒëœ ë©”ëª¨ì˜ ì´ë²¤íŠ¸ ê°ì²´

    // ë©”ëª¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function loadMemos() {
        $.ajax({
            url: '/api/memos/all',  // ë©”ëª¨ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” API í˜¸ì¶œ
            type: 'GET',  // GET ìš”ì²­ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
            success: function(response) {
                // ì‘ë‹µ ë°ì´í„°ë¥¼ í†µí•´ ì´ë²¤íŠ¸ ê°ì²´ ìƒì„±
                var events = response.map(function(memo) {
                    return {
                        id: memo.id,  // ë©”ëª¨ ID
                        title: memo.memo,  // ë©”ëª¨ ë‚´ìš©
                        start: memo.date,  // ë©”ëª¨ ë‚ ì§œ
                        description: memo.displayName  // ë©”ëª¨ ì‘ì„±ì ì´ë¦„
                    };
                });

                // ë‹¬ë ¥ì— ì´ë²¤íŠ¸ ë°ì´í„° ì¶”ê°€
                $('#calendar').fullCalendar('removeEvents');  // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±°
                $('#calendar').fullCalendar('addEventSource', events);  // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ì¶”ê°€

                // ì´ì „ ë‹¬ ë©”ëª¨ ë³„ë„ ì˜ì—­ì— í‘œì‹œ
                displayPreviousMonthMemos(response);
                // ì´ë²ˆ ë‹¬ ë©”ëª¨ ë³„ë„ ì˜ì—­ì— í‘œì‹œ
                displayCurrentMonthMemos(response);
            },
            error: function(xhr, status, error) {
                alert('ë©”ëª¨ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ì´ì „ ë‹¬ ë©”ëª¨ ë³„ë„ í‘œì‹œ í•¨ìˆ˜
    function displayPreviousMonthMemos(memos) {
        var currentDate = moment();  // í˜„ì¬ ë‚ ì§œ
        currentDate.subtract(1, 'months');  // í•œ ë‹¬ ì „ìœ¼ë¡œ ì„¤ì •

        var previousMonth = currentDate.month();  // ì´ì „ ë‹¬ì˜ ì›” ë²ˆí˜¸

        // ì´ì „ ë‹¬ì˜ ë©”ëª¨ í•„í„°ë§
        var previousMonthMemos = memos.filter(function(memo) {
            return moment(memo.date).month() === previousMonth;
        });

        // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ (ì˜¤ë¦„ì°¨ìˆœ)
        previousMonthMemos.sort(function(a, b) {
            return moment(a.date).isBefore(moment(b.date)) ? -1 : 1;
        });

        var memoList = $('#memoListLeft');
        memoList.empty();  // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°

        // ì´ì „ ë‹¬ ë©”ëª¨ ëª©ë¡ í‘œì‹œ
        previousMonthMemos.forEach(function(memo) {
            memoList.append('<li>' + memo.date + ' : ' + memo.memo + '</li>');
        });
    }

    // ì´ë²ˆ ë‹¬ ë©”ëª¨ ë³„ë„ í‘œì‹œ í•¨ìˆ˜
    function displayCurrentMonthMemos(memos) {
        var currentDate = moment();  // í˜„ì¬ ë‚ ì§œ
        var currentMonth = currentDate.month();  // ì´ë²ˆ ë‹¬ì˜ ì›” ë²ˆí˜¸

        // ì´ë²ˆ ë‹¬ì˜ ë©”ëª¨ í•„í„°ë§
        var currentMonthMemos = memos.filter(function(memo) {
            return moment(memo.date).month() === currentMonth;
        });

        // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ (ì˜¤ë¦„ì°¨ìˆœ)
        currentMonthMemos.sort(function(a, b) {
            return moment(a.date).isBefore(moment(b.date)) ? -1 : 1;
        });

        var memoList = $('#memoListRight');
        memoList.empty();  // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°

        // ì´ë²ˆ ë‹¬ ë©”ëª¨ ëª©ë¡ í‘œì‹œ
        currentMonthMemos.forEach(function(memo) {
            memoList.append('<li>' + memo.date + ' : ' + memo.memo + '</li>');
        });
    }

    // FullCalendar ì´ˆê¸°í™”
    $('#calendar').fullCalendar({
        locale: "ko",  // í•œêµ­ì–´ ì„¤ì •
        header: {
            left: 'prev,next today',  // ì´ì „, ë‹¤ìŒ, ì˜¤ëŠ˜ ë²„íŠ¼
            center: 'title',  // ë‹¬ë ¥ ì œëª©
            right: 'month,agendaWeek,agendaDay'  // ì›”, ì£¼, ì¼ ë³´ê¸°
        },
        events: [],  // ì´ˆê¸° ì´ë²¤íŠ¸ ì„¤ì • (ë¹ˆ ë°°ì—´)
        selectable: true,  // ë‚ ì§œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
        select: function(startDate, endDate) {
            selectedDate = startDate;  // ì„ íƒëœ ë‚ ì§œ ì €ì¥
            $('#memoModal').show();  // ë©”ëª¨ ì…ë ¥ ëª¨ë‹¬ ì°½ ë³´ì´ê¸°

            var formattedDate = selectedDate.format('YYYY-MM-DD');  // ì„ íƒëœ ë‚ ì§œ í¬ë§·
            $('#selectedDateText').text(formattedDate);  // ëª¨ë‹¬ì— ì„ íƒëœ ë‚ ì§œ í‘œì‹œ
            $('#displayNameText').text(displayName);  // ëª¨ë‹¬ì— ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ

            $('#memoText').val('');  // ë©”ëª¨ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            currentEvent = null;  // í˜„ì¬ ì„ íƒëœ ì´ë²¤íŠ¸ ì´ˆê¸°í™”
            $('#deleteMemo').hide();  // ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        },
        eventClick: function(event) {
            selectedDate = moment(event.start);  // í´ë¦­ëœ ì´ë²¤íŠ¸ì˜ ì‹œì‘ ë‚ ì§œ
            currentEvent = event;  // í˜„ì¬ ì„ íƒëœ ì´ë²¤íŠ¸ ê°ì²´ ì €ì¥

            $('#memoModal').show();  // ë©”ëª¨ ì…ë ¥ ëª¨ë‹¬ ì°½ ë³´ì´ê¸°
            $('#selectedDateText').text(moment(event.start).format('YYYY-MM-DD'));  // ì„ íƒëœ ë‚ ì§œ í‘œì‹œ
            $('#displayNameText').text(event.description);  // ì‘ì„±ì ì´ë¦„ í‘œì‹œ
            $('#memoText').val(event.title);  // ë©”ëª¨ ë‚´ìš© í‘œì‹œ
            $('#deleteMemo').show();  // ì‚­ì œ ë²„íŠ¼ ë³´ì´ê¸°
        }
    });


    // ë©”ëª¨ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
    $('#saveMemo').click(function () {
        var memoText = $('#memoText').val();
        if (memoText) {
            var memoData = {
                date: $('#selectedDateText').text(),  // ì„ íƒëœ ë‚ ì§œ
                displayName: $('#displayNameText').text(),  // ì‘ì„±ì ì´ë¦„
                memo: memoText  // ë©”ëª¨ ë‚´ìš©
            };

            // í˜„ì¬ ì´ë²¤íŠ¸ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸ ìš”ì²­
            if (currentEvent) {
                $.ajax({
                    url: '/api/memos/update/' + currentEvent.id,  // ë©”ëª¨ ìˆ˜ì • API
                    type: 'PUT',  // PUT ìš”ì²­
                    contentType: 'application/json',  // JSON í˜•ì‹
                    data: JSON.stringify(memoData),  // ë°ì´í„° ì „ì†¡
                    success: function(response) {
                        alert('ë©”ëª¨ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadMemos();  // ë©”ëª¨ ëª©ë¡ ê°±ì‹ 
                        $('#memoModal').hide();  // ëª¨ë‹¬ ì°½ ë‹«ê¸°
                    },
                    error: function(xhr, status, error) {
                        console.error('ë©”ëª¨ ìˆ˜ì • ì‹¤íŒ¨:', error);  // ì˜¤ë¥˜ ë©”ì‹œì§€ ë¡œê·¸ ì¶œë ¥
                        alert('ë©”ëª¨ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            } else {
                $.ajax({
                    url: '/api/memos/save',  // ë©”ëª¨ ì €ì¥ API
                    type: 'POST',  // POST ìš”ì²­
                    contentType: 'application/json',  // JSON í˜•ì‹
                    data: JSON.stringify(memoData),  // ë°ì´í„° ì „ì†¡
                    success: function(response) {
                        alert('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadMemos();  // ë©”ëª¨ ëª©ë¡ ê°±ì‹ 
                        $('#memoModal').hide();  // ëª¨ë‹¬ ì°½ ë‹«ê¸°
                    },
                    error: function(xhr, status, error) {
                        console.error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:', error);  // ì˜¤ë¥˜ ë©”ì‹œì§€ ë¡œê·¸ ì¶œë ¥
                        alert('ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            }
        } else {
            alert('ë©”ëª¨ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.');  // ë©”ëª¨ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì•Œë¦¼
        }
    });

    // ë©”ëª¨ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ
    $('#cancelMemo').click(function() {
        $('#memoModal').hide();  // ëª¨ë‹¬ ì°½ ë‹«ê¸°
    });

    // ë©”ëª¨ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
    $('#deleteMemo').click(function() {
        if (currentEvent) {
            $.ajax({
                url: '/api/memos/delete/' + currentEvent.id,  // ë©”ëª¨ ì‚­ì œ API
                type: 'DELETE',  // DELETE ìš”ì²­
                success: function(response) {
                    alert('ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadMemos();  // ë©”ëª¨ ëª©ë¡ ê°±ì‹ 
                    $('#memoModal').hide();  // ëª¨ë‹¬ ì°½ ë‹«ê¸°
                },
                error: function(xhr, status, error) {
                    alert('ë©”ëª¨ ì‚­ì œ ì‹¤íŒ¨');
                }
            });
        }
    });

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    loadMemos();  // ë©”ëª¨ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
});

</script>
</body>
</html>
