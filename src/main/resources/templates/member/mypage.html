<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>마이페이지</title>
	<link href="/main.css" rel="stylesheet">
	<link href="member/mypage.css" rel="stylesheet">
</head>

<body>
	<div th:replace="~{nav.html::navbar}"></div>

	<div class="container">
		<div class="mypage-card">
			<h2>마이페이지</h2>

			<div class="user-info">
				<p><strong>아이디:</strong> <span sec:authentication="principal.username"></span></p>
				<div sec:authorize="hasAuthority('ROLE_USER')">
					<p class="user-role">이 유저는 일반 유저입니다.</p>
				</div>

				<div sec:authorize="hasAuthority('ROLE_ADMIN')">
					<p class="admin-role">이 유저는 관리자입니다.</p>
				</div>

			</div>
			<!-- 출퇴근 기록 폼 추가 -->
			<!--ALTER TABLE attendance MODIFY COLUMN type VARCHAR(255); 추가해야함-->
			<h2 style="margin-top: 30px;">출퇴근 기록 추가</h2>
			<form action="/attendance/addAttendance" method="post" onsubmit="return validateForm()">
				<input type="hidden" id="attendanceId" name="attendanceId" th:value="${attendanceId}">
				<input type="hidden" id="checkIn" name="checkIn">
				<label for="type">근태 유형:</label>
				<select id="type" name="type" required>
					<option value="WORK">정상 근무</option>
					<option value="VACATION">휴가</option>
					<option value="SICK">병가</option>
					<option value="DISPATCH">파견</option>
					<option value="EARLY_LEAVE">조퇴</option>
					<option value="ABSENCE">무단결근</option>
				</select><br>

				<label for="checkInDisplay">출근 시간:</label>
				<input type="text" id="checkInDisplay" readonly>
				<button class="clock" type="button" onclick="setCheckInTime()">출근 시간 기록</button><br>

				<button class="upload-btn" type="submit">출퇴근 기록 추가</button>
			</form>



			<!-- <button class="logout-btn" onclick="location.href='/logout'">로그아웃</button>-->
		</div>


		<div class="contract-header">
			<h3>계약서 목록</h3>
			<button onclick="location.href='/contracts/upload-form'" class="upload-btn">
				계약서 업로드 바로가기
			</button>
		</div>


		<table class="mypage-table">
			<thead>
				<tr>
					<th>제목</th>
					<th>시작일</th>
					<th>종료일</th>
					<th>확인/미확인</th>
					<th>파일</th>
					<th>삭제여부</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="contract : ${contracts}"
					th:classappend="${contract.endDate != null and contract.endDate < now} ? 'expired' : ''">
					<td th:text="${contract.title}">제목</td>
					<td th:text="${contract.startDate}">시작일</td>
					<td th:text="${contract.endDate}">종료일</td>
					<td th:text="${contract.notified ? '확인' : '미확인'}">알림 상태</td>
					<td>
						<a th:href="@{/contracts/download(path=${contract.filePath})}">다운로드</a>
					</td>
					<td>
						<form th:action="@{/contracts/delete}" method="post" style="display:inline;">
							<input type="hidden" name="contractId" th:value="${contract.id}" />
							<button type="submit" onclick="return confirm('정말 삭제하시겠습니까?')">삭제</button>
						</form>
					</td>
				</tr>


			</tbody>
		</table>

		<!--<div class="mypage-table-container">
        <th:block th:each="entry : ${groupedOrders}">
            <h3 class="order-date-title" th:text="${entry.key}">주문 날짜</h3>  날짜 제목 

            <table class="mypage-table">
                <thead>
                <tr>
                    <th>상품명</th>
                    <th>가격</th>
                    <th>수량</th>
                    <th>구매자</th>
                    <th>주문 날짜</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="order : ${entry.value}">
                    <td th:text="${order.itemName}"></td>
                    <td th:text="${order.price}"></td>
                    <td th:text="${order.count}"></td>
                    <td th:text="${order.member.displayName}"></td>
                    <td th:text="${#temporals.format(order.created, 'HH:mm:ss')}"></td>  시간만 표시 
                </tr>
                </tbody>
            </table>
        </th:block>
    </div>-->


	</div>
</body>
<script>
	function downloadAndRefresh(anchor) {
		const url = anchor.getAttribute('data-url');
		const link = document.createElement('a');
		link.href = url;
		link.download = '';
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);

		// ✅ 다운로드 후 1초 뒤 페이지 새로고침
		setTimeout(() => {
			location.reload();
		}, 1000);
	}


	let checkInTime = null;  // 출근 시간 저장용

	// 현재 시간 (local time) 반환 함수
	function getNowDatetimeLocal() {
		const now = new Date(); // 현재 시간을 바로 가져옵니다.

		const year = now.getFullYear();
		const month = String(now.getMonth() + 1).padStart(2, '0');
		const day = String(now.getDate()).padStart(2, '0');
		const hours = String(now.getHours()).padStart(2, '0');
		const minutes = String(now.getMinutes()).padStart(2, '0');

		// 'YYYY-MM-DD HH:MM' 형식으로 반환
		return `${year}-${month}-${day} ${hours}:${minutes}`;
	}

	// 출근 시간 기록 함수
	function setCheckInTime() {
		checkInTime = getNowDatetimeLocal();  // 출근 시간 저장
		document.getElementById('checkInDisplay').value = checkInTime;
		document.getElementById('checkIn').value = checkInTime;  // 히든 필드에 저장
		alert("출근 시간이 기록되었습니다.");
	}

	// 폼 제출 시 출퇴근 시간 검사
	function validateForm() {
		if (!checkInTime) {
			alert("출근 시간을 먼저 기록해주세요.");
			return false;
		}
		return true;
	}

</script>
<style>
	/* main.css 또는 mypage.css에 추가 */
	.upload-btn {
		padding: 10px 20px;
		background-color: #4CAF50;
		color: white;
		border: none;
		border-radius: 6px;
		cursor: pointer;
		font-size: 14px;
		margin-top: 15px;
	}

	.upload-btn:hover {
		background-color: #45a049;
	}
</style>

</html>